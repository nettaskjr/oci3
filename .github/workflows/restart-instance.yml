name: Restart OCI Instance

on:
    workflow_dispatch:
        inputs:
            instance_display_name:
                description: "Nome de exibição da instância para reiniciar"
                required: true
                default: "nettask-com-br"
            action_type:
                description: "Tipo de reset (SOFTRESET, RESET, STOP, START)"
                required: true
                default: "SOFTRESET"
                type: choice
                options:
                    - SOFTRESET
                    - RESET
                    - STOP
                    - START

env:
    OCI_CLI_USER: ${{ secrets.OCI_USER_OCID }}
    OCI_CLI_TENANCY: ${{ secrets.OCI_TENANCY_OCID }}
    OCI_CLI_FINGERPRINT: ${{ secrets.OCI_FINGERPRINT }}
    OCI_CLI_KEY_CONTENT: ${{ secrets.OCI_PRIVATE_KEY_PEM }}
    OCI_CLI_REGION: ${{ secrets.OCI_REGION }}

jobs:
    restart-instance:
        runs-on: ubuntu-latest
        name: Restart Instance

        steps:
            - name: Install OCI CLI
              uses: oracle-actions/setup-oci-cli@v1.2.0
              with:
                  fingerprint: ${{ secrets.OCI_FINGERPRINT }}
                  user: ${{ secrets.OCI_USER_OCID }}
                  tenancy: ${{ secrets.OCI_TENANCY_OCID }}
                  region: ${{ secrets.OCI_REGION }}
                  api_key: ${{ secrets.OCI_PRIVATE_KEY_PEM }}

            - name: Find Instance ID
              id: find_instance
              run: |
                  echo "Searching for instance: ${{ github.event.inputs.instance_display_name }}..."
                  INSTANCE_ID=$(oci compute instance list \
                    --compartment-id ${{ secrets.OCI_COMPARTMENT_OCID }} \
                    --display-name "${{ github.event.inputs.instance_display_name }}" \
                    --lifecycle-state RUNNING \
                    --query "data[0].id" \
                    --raw-output)

                  if [ "$INSTANCE_ID" == "null" ] || [ -z "$INSTANCE_ID" ]; then
                     # Tenta procurar qualquer estado se não estiver RUNNING e a ação for START
                     if [ "${{ github.event.inputs.action_type }}" == "START" ]; then
                        INSTANCE_ID=$(oci compute instance list \
                          --compartment-id ${{ secrets.OCI_COMPARTMENT_OCID }} \
                          --display-name "${{ github.event.inputs.instance_display_name }}" \
                          --lifecycle-state STOPPED \
                          --query "data[0].id" \
                          --raw-output)
                     fi
                  fi

                  if [ "$INSTANCE_ID" == "null" ] || [ -z "$INSTANCE_ID" ]; then
                    echo "Instance not found!"
                    exit 1
                  fi

                  echo "Found Instance ID: $INSTANCE_ID"
                  echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT

            - name: Execute Action
              run: |
                  echo "Performing ${{ github.event.inputs.action_type }} on ${{ steps.find_instance.outputs.instance_id }}..."
                  oci compute instance action \
                    --instance-id ${{ steps.find_instance.outputs.instance_id }} \
                    --action ${{ github.event.inputs.action_type }} \
                    --wait-for-state RUNNING \
                    --wait-interval-seconds 10

            - name: Notify Discord (Optional)
              if: always() && secrets.DISCORD_WEBHOOK_URL != ''
              run: |
                  STATUS="${{ job.status }}"
                  if [ "$STATUS" == "success" ]; then
                     MSG="✅ Instância **${{ github.event.inputs.instance_display_name }}** reiniciada com sucesso via GitHub Actions!"
                  else
                     MSG="❌ Falha ao reiniciar instância **${{ github.event.inputs.instance_display_name }}**."
                  fi

                  curl -H "Content-Type: application/json" \
                    -d "{\"content\": \"$MSG\"}" \
                    "${{ secrets.DISCORD_WEBHOOK_URL }}"
