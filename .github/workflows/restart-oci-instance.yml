name: Restart OCI Instance

on:
    workflow_dispatch: # Gatilho manual (ClickOps)

jobs:
    restart-instance:
        runs-on: ubuntu-latest
        name: Restart Instance via OCI CLI
        steps:
            - name: Get Instance OCID
              id: get-instance
              uses: oracle-actions/run-oci-cli-command@v1.3.2
              env:
                  OCI_CLI_USER: ${{ secrets.OCI_USER_OCID }}
                  OCI_CLI_TENANCY: ${{ secrets.OCI_TENANCY_OCID }}
                  OCI_CLI_FINGERPRINT: ${{ secrets.OCI_FINGERPRINT }}
                  OCI_CLI_KEY_CONTENT: ${{ secrets.OCI_PRIVATE_KEY_PEM }}
                  OCI_CLI_REGION: ${{ secrets.OCI_REGION }}
              with:
                  command: compute instance list --compartment-id ${{ secrets.OCI_COMPARTMENT_OCID }} --lifecycle-state RUNNING --sort-by TIMECREATED --sort-order DESC --query "data[0].id" --raw-output --all

            - name: Clean Instance ID
              id: clean-id
              run: |
                  RAW_ID="${{ steps.get-instance.outputs.raw_output }}"
                  CLEAN_ID=$(echo "$RAW_ID" | tr -d '[:space:]')
                  echo "clean_output=$CLEAN_ID" >> $GITHUB_OUTPUT
                  echo "Original: [$RAW_ID]"
                  echo "Cleaned:  [$CLEAN_ID]"

            - name: Restart Instance
              if: success() && steps.clean-id.outputs.clean_output != ''
              uses: oracle-actions/run-oci-cli-command@v1.3.2
              env:
                  OCI_CLI_USER: ${{ secrets.OCI_USER_OCID }}
                  OCI_CLI_TENANCY: ${{ secrets.OCI_TENANCY_OCID }}
                  OCI_CLI_FINGERPRINT: ${{ secrets.OCI_FINGERPRINT }}
                  OCI_CLI_KEY_CONTENT: ${{ secrets.OCI_PRIVATE_KEY_PEM }}
                  OCI_CLI_REGION: ${{ secrets.OCI_REGION }}
              with:
                  silent: false
                  command: compute instance action --instance-id ${{ steps.clean-id.outputs.clean_output }} --action SOFTRESET --wait-for-state RUNNING

            - name: Notify Discord
              if: always()
              env:
                  DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
                  STATUS: ${{ job.status }}
              run: |
                  if [ -z "$DISCORD_WEBHOOK_URL" ]; then echo "No Discord Webhook configured"; exit 0; fi

                  if [ "$STATUS" == "success" ]; then
                    COLOR=3066993 # Green
                    TITLE="✅ OCI Instance Restarted"
                    DESC="A instância foi reiniciada com sucesso via GitHub Actions."
                  else
                    COLOR=15158332 # Red
                    TITLE="❌ OCI Instance Restart Failed"
                    DESC="Falha ao tentar reiniciar a instância. Verifique os logs do Action."
                  fi

                  curl -H "Content-Type: application/json" \
                    -d "{\"embeds\": [{\"title\": \"$TITLE\", \"description\": \"$DESC\", \"color\": $COLOR}]}" \
                    "$DISCORD_WEBHOOK_URL"
